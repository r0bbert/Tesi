\section{E-Graphs}\label{sect:eggs}

\newcommand{\EGG}{\mathbf{EGG}}

\todo[color=green!40]{
    COSE DA FARE:
Questa sezione ha più o meno gli stessi problemi della precedente. L'ordine da rispettare imho è il seguente:
>Definizione
>Calcolo dei limiti e certi colimiti (si fanno come in EqGrph)
> cor del calcolo dei limiti: caratterizzare mono regolari
>I crea limiti e i giusti pushout
> e-graph sono quasiadesivi
}

E-Graphs are a particular type of graphs with equivalences, in which holds that
$$
    \frac{s(e) \sim s(e')}{t(e) \sim t(e')}
$$
for each pair of edges $e$, $e'$ of $\eqgraph{G} = (G, \sim)$.
In a more general case, considering a graph with equivalence as a functor $\eqgraph{G} : (E \rightrightarrows V \rightarrow Q) \rightarrow \Set$, the inference rule above rewrites as
\[
    \frac{\eqgraph{G}(q \circ s)(e) = \eqgraph{G}(q \circ s)(e')}{\eqgraph{G}(q \circ t)(e) = \eqgraph{G}(q \circ t)(e')}
\] for each $e$, $e' \in \eqgraph{G}(E)$.
But this is to say that, given the two set $S = \{ (e, e') \in \eqgraph{G}(E) \times \eqgraph{G}(E) \mid \eqgraph{G}(q \circ s)(e) = \eqgraph{G}(q \circ s)(e') \}$ and $T =\{ (e, e') \in \eqgraph{G}(E) \times \eqgraph{G}(E) \mid \eqgraph{G}(q \circ t)(e) = \eqgraph{G}(q \circ t)(e') \} $, $S \subseteq T$. But $S$ (with the projection arrows $p_1$ and $p_2$) is exactly the kernel pair of $\eqgraph{G}(q \circ s)$, and $T$ (together with the projections $q_1, q_2$) is the kernel pair of $\eqgraph{G}(q \circ t)$ (\Cref{ex:kernel_pairs_in_Set}). Then, a more general way to express that $\eqgraph{G}$ is an e-graph is by saying that $\eqgraph{G}$ is such that there exists a monomorphism, which is the canonical inclusion, in $\Set$ from $S$ to $T$.
To find a structure to express this fact, we have to consider a more general case.

Since both $S$ and $T$ are subobjects of $\eqgraph{G}(E) \times \eqgraph{G}(E)$, we can make use of the \Cref{prop:fact_of_subobjects_is_unique}. Specifically, we want, in the following situation, $i$ to be mono and unique.
\[
    \begin{tikzcd}
        S \arrow[rr, "i"] \arrow[dr, "{\langle p_1, p_2 \rangle}"swap] & & T \arrow[dl, "{\langle q_1, q_2\rangle}"] \\
        & \eqgraph{G}(E) \times \eqgraph{G}(E)
    \end{tikzcd}
\]
% We have then that $\langle p_1, p_2 \rangle$ is mono, then so is $\langle q_1, q_2 \rangle \circ i$. From \Cref{prop:epi_mono_prop}, we can conclude that $i$ is mono too. The uniqueness follows from \Cref{prop:fact_of_subobjects_is_unique}. If such $i$ exists, then $\eqgraph{G}$ is an e-graph.

\begin{definition}[Category of E-Graphs]\label{def:cat_of_eggs}
    $\EGG$ is the subcategory of $\EqGrph$ such that
	\begin{itemize}
		\item $\eqgraph{G} \in \EGG$ if, being $(S, p_1, p_2)$ and $(T, q_1, q_2)$, respectively, the kernel pair of $\eqgraph{G}(q \circ s)$ and the kernel pair of $\eqgraph{G}(q \circ t)$, it holds that $\langle p_1, p_2 \rangle \leq \langle q_1, q_2 \rangle$ (in the sense of \Cref{def:subobj});
		\item given two e-graphs $\eqgraph{G, H}$, $\EGG(\eqgraph{G, H}) =\EqGrph(\eqgraph{G, H})$ (i.e., a full subcategory).
	\end{itemize}
\end{definition}

Since $\EGG$ is a full subcategory of $\EqGrph$, there exists a fully faithful functor $I: \EGG \to \EqGrph$ (\Cref{ex:full_subc_inc_fully_faith}).

\begin{lemma}
	$\EGG$ has all limits and $I$ preserves them.
\end{lemma}

\begin{proof}
	Let $D: \cat{I} \to \EGG$ be a diagram, with $D(i) = (A_i, B_i, C_i, s_i, t_i, q_i)$, let $(U, u_1^i, u_2^i)$ be the kernel pair of $q_i\circ s_i$. Let now be $(A, B, C, s, t, q)$, togehter with projections $(\pi_E^i, \pi_V^i, \pi_C^i)_{i \in \cat I}$ the limit of $I \circ D$, let $(U, u_1, u_2)$ be the kernel pair of $q\circ s$ and let $(L, (l_i)_{i \in \cat I})$ be the limit of $V\circ I\circ D$.
	By construction (proof of \Cref{???}\todo{citazione}), there exists a monomorphism $m: Q \to L$ such that $\pi_C^i = l_i \circ m$. Notice that
	\begin{align*}
		q_i\circ s_i\circ \pi^i_E\circ u_1 	&= q_i\circ \pi^i_V\circ s\circ u_1\\
							&= \pi_C^i\circ q\circ s\circ u_1\\
							&=\pi_C^i\circ q\circ s\circ u_2\\
							&= q_i \circ s_i \circ \pi_E^i \circ u_2
	\end{align*}
	Then, for each $i$, there exists an arrow $a_i:U\to U_i$ making the following diagram to commute
	\[
		\begin{tikzcd}[row sep = 25, column sep = 25]
			U \ar[r, "{u_1}"] \ar[d, "{u_2}"swap font=\small] \ar[dr, dashed, "{a_i}"] & A \ar[drr, "{\pi_E^i}"] && \\
			A \ar[ddr, "{\pi_E^i}"swap] & U_i \ar[rr, "{u_1^i}"] \ar[dd, "{u_2^i}"swap]&& A_i \ar[d, "{s_i}"] \\
			& & & B_i \ar[d, "{q_i}"]\\
			& A_i \ar[r, "{s_i}"swap] & B_i \ar[r, "{q_i}"swap] & C_i
		\end{tikzcd}
	\]
	We have then
	\begin{align*}
		l_i\circ m \circ q \circ t \circ u_1	&= q_i \circ \pi_V^i \circ t \circ u_1 \\
							&= q_i \circ t_i \circ \pi_E^i \circ u_1 \\
							&= q_i \circ t_i \circ u_1^i \circ a_i \\
							&= q_i \circ t_i \circ u_2^i \circ a_i \\
							&= q_i \circ t_i \circ \pi_E^i \circ u_2 \\
							&= q_i \circ \pi_V^i \circ t \circ u_2 \\
							&= l_i \circ m \circ q \circ t \circ u_2
	\end{align*}
	By universal property of limits, we have that $m\circ q \circ t \circ u_1 = m \circ q \circ t \circ u_2$, and, since $m$ is mono, $q \circ t \circ u_1 = q \circ t \circ u_2$, hence the thesis.
\end{proof}


APPUNTI
Chiamiamo $(A_i, B_i, Q_i, s_i, t_i, q_i)$ le componenti del diagramma. Chiamiamo $(U_i, u_{1, i} , u_{2,i})$ il kernel pair di $q_i\circ s_i$.  Sia $(A, B, Q, s,t,q )$ il limite in $\EqGrph$ e $(U, u_1, u_2)$ il kernel pair di $q\circ s$. Vogliamo far vedere che $q\circ t \circ u_1= q\circ t\circ u_2$. Sia anche $(L, l_i)$ il limite del diagramma dato dai $Q_i$. In particolare abbiamo $m\colon Q\to L$ mono.

Osserviamo che 
\begin{align*}
q_i\circ s_i\circ \pi^i_E\circ u_1 &= q_i\circ \pi^i_V\circ s\circ u_1\\&= \pi^i\circ q\circ s\circ u_1\\&=\pi^i\circ q\circ s\circ u_2=\dots (percorso al contrario)
\end{align*}

Dunque per ogni $i$ esiste una freccia $a_i\colon U\to U_{i}$ tale che il diagramma sotto commuta
\[
\xymatrix{U \ar@{.>}[dr]^{a_i}\ar[r]^{u_1} \ar[d]_{u_2}& A \ar[drr]^{\pi^i_E}\\A \ar[ddr]_{\pi^i_E}&U_i \ar[dd]_{u_{2,i}} \ar[rr]^{u_{1,i}}& & A_i \ar[d]^{s_i}\\
& & &B_i \ar[d]^{q_i}\\&A_i \ar[r]_{s_i} & B_i \ar[r]_{s_i} & Q_i}
\]


\begin{align*}
	l_i\circ m\circ q\circ t \circ u_1 &= q_i \circ \pi^{i}_V\circ t\circ u_1 \\&=q_i\circ t_i\circ \pi^i_E\circ u_1\\&=q_i\circ t_i\circ u_{1,i}\circ a_i\\&=q_i\circ t_i\circ u_{2,i}\circ a_i\\=\dots (uguaglianze al contrario)
\end{align*}

Dunque le frecce $m\circ q\circ t \circ u_1, m\circ q\circ t \circ u_2\colon U\rightrightarrows L$ sono uguali. Ma $m$ è mono per costruzione e allora $q\circ t \circ u_1=q\circ t \circ u_2$.

FINE APPUNTI 


\begin{proof}
	Let $D: \cat I \to \EGG$ be a diagram, and suppose $(\eqgraph{L}, (l_i)_{i \in \cat{I}})$ be a limit for $I \circ D$, where $l_i = (l_E^i, l_V^i, l_C^i)$. Then, it is sufficient to show that $(\eqgraph{L}, (l_i)_{i \in \cat I})$ is a limit for $D$ (i.e., $\eqgraph{L}$ is an e-graph). To see this, consider $e, e' \in \eqgraph{L}(E)$, and suppose $\eqgraph{L}(q \circ s)(e) = \eqgraph{L}(q \circ s)(e')$. Then, we have $(l_C^i \circ \eqgraph{L}(q \circ s))(e) = (l_C^i \circ \eqgraph{L}(q \circ s))(e')$, but, since
	\[\begin{split}
		l_C^i \circ \eqgraph{L}(q \circ s) &= l_C^i \circ \eqgraph{L}(q) \circ \eqgraph{L}(s) \\
						   &= D(i)(q) \circ l_V^i \circ \eqgraph{L}(s)	\\
						   &= D(i)(q \circ s)\circ l_E^i
	\end{split}\]
	the equation above rewrites as
	\[(D(i)(q \circ s))(l_E^i (e)) = (D(i)(q \circ s))(l_E^i (e')) \]
	Since $D(i)$ is an e-graph, we have then
	\[(D(i)(q \circ t))(l_E^i (e)) = (D(i)(q \circ t))(l_E^i (e')) \]
	and, retracing the previous steps, \[ (l_C^i \circ \eqgraph{L}(q \circ t))(e) = (l_C^i \circ \eqgraph{L}(q \circ t))(e')\]
	\todo{finire qui.}
\end{proof}

